<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Sports Statistics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="header">
    <h1>NBA Statistics</h1>
    
    <div class="dataset-selector">
      <label class="form-label" style="margin: 0;">Dataset:</label>
      <select id="datasetSelect" class="form-select" style="width: auto;">
        <option value="">Choose Dataset</option>
        {% for ds in available_datasets %}
          <option value="{{ ds }}" {% if ds == current_dataset %}selected{% endif %}>{{ ds }}</option>
        {% endfor %}
      </select>
      <button onclick="loadSelectedDataset()" class="btn btn-primary">Load</button>
    </div>
  </div>

  <div class="container">
    {% if not current_dataset %}
    <div class="card">
      <div class="empty-state">
        <h2>Select a dataset to begin</h2>
        <p>Choose a CSV file from the dropdown above</p>
      </div>
    </div>
    {% else %}
    <div class="grid">
      <div class="card">
        <h2 class="card-title">Query Builder</h2>

        {% if query_state.filters or (not query_state.show_all_columns and query_state.selected_columns) or query_state.join_dataset or query_state.aggregation_column %}
        <div class="query-summary">
          <div class="query-summary-title">Active Query Settings</div>
          {% if query_state.filters %}
          <div>Filters: {{ query_state.filters|length }} active</div>
          {% endif %}
          {% if not query_state.show_all_columns and query_state.selected_columns %}
          <div>Columns: {{ query_state.selected_columns|length }} selected</div>
          {% endif %}
          {% if query_state.join_dataset %}
          <div>Join: {{ query_state.join_dataset }}</div>
          {% endif %}
          {% if query_state.aggregation_column and query_state.aggregation_function %}
          <div>Aggregation: {{ query_state.aggregation_function.upper() }}({{ query_state.aggregation_column }})</div>
          {% elif query_state.aggregation_group_by %}
          <div>Group By: {{ query_state.aggregation_group_by }}</div>
          {% endif %}
          {% if query_state.use_limit %}
          <div>Limit: {{ query_state.limit }} rows</div>
          {% endif %}
        </div>
        {% endif %}

        <div class="tabs">
          <button class="tab-btn active" onclick="switchTab('filter', this)">Filter</button>
          <button class="tab-btn" onclick="switchTab('columns', this)">Columns</button>
          <button class="tab-btn" onclick="switchTab('aggregate', this)">Aggregate</button>
          <button class="tab-btn" onclick="switchTab('join', this)">Join</button>
          <button class="tab-btn" onclick="switchTab('limit', this)">Limit</button>
        </div>

        <div id="tab-filter" class="tab-content active">
          {% if query_state.filters %}
          <div class="filter-list">
            {% for filter in query_state.filters %}
            <div class="filter-item">
              <span>{{ filter.column }} {{ filter.op }} {{ filter.value }}</span>
              <form method="post" action="/?action=remove_filter" style="display: inline;">
                <input type="hidden" name="filter_index" value="{{ loop.index0 }}">
                <button type="submit" class="remove-btn">Remove</button>
              </form>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div style="padding: 10px; background: #fafafa; border-radius: 4px; margin-bottom: 15px; text-align: center; color: #999;">
            No filters applied
          </div>
          {% endif %}

          <form method="post" action="/?action=add_filter">
            <div class="form-row-3">
              <div class="form-group">
                <label class="form-label">Column</label>
                <select name="filter_column" class="form-select">
                  {% for col in columns %}
                    <option value="{{ col }}">{{ col }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Operator</label>
                <select name="filter_op" class="form-select">
                  <option value=">">></option>
                  <option value=">=">≥</option>
                  <option value="<"><</option>
                  <option value="<=">≤</option>
                  <option value="==">==</option>
                  <option value="!=">≠</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Value</label>
                <input type="text" name="filter_value" class="form-input" placeholder="e.g., 30">
              </div>
            </div>
            <div class="button-group">
              <button type="submit" class="btn btn-success">Add Filter</button>
              {% if query_state.filters %}
              <button type="submit" formaction="/?action=clear_filters" class="btn btn-secondary">Clear All</button>
              {% endif %}
            </div>
          </form>
        </div>

        <div id="tab-columns" class="tab-content">
          <form method="post" action="/?action=update_columns">
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" name="show_all_columns" id="show_all_columns" 
                       {% if query_state.show_all_columns %}checked{% endif %} onchange="toggleColumnSelection()">
                Show All Columns
              </label>
            </div>
            
            <div id="columnSelection" {% if query_state.show_all_columns %}style="display:none"{% endif %}>
              <div class="form-group">
                <label class="form-label">Select Columns</label>
                <div class="checkbox-grid">
                  {% for col in columns %}
                    <label class="checkbox-label">
                      <input type="checkbox" name="selected_columns" value="{{ col }}" 
                             {% if col in query_state.selected_columns %}checked{% endif %}>
                      {{ col }}
                    </label>
                  {% endfor %}
                </div>
              </div>
            </div>
            
            <div class="button-group">
              <button type="submit" class="btn btn-primary">Apply</button>
            </div>
          </form>
        </div>

        <div id="tab-aggregate" class="tab-content">
          <form method="post" action="/?action=update_aggregation">
            <div class="form-group">
              <label class="form-label">Group By</label>
              <select name="aggregation_group_by" class="form-select">
                <option value="">No Grouping</option>
                {% for col in columns %}
                  <option value="{{ col }}" {% if query_state.aggregation_group_by == col %}selected{% endif %}>{{ col }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Function (Optional)</label>
              <select name="aggregation_function" class="form-select">
                <option value="">No Aggregation</option>
                <option value="sum" {% if query_state.aggregation_function == 'sum' %}selected{% endif %}>SUM</option>
                <option value="avg" {% if query_state.aggregation_function == 'avg' %}selected{% endif %}>AVERAGE</option>
                <option value="max" {% if query_state.aggregation_function == 'max' %}selected{% endif %}>MAXIMUM</option>
                <option value="min" {% if query_state.aggregation_function == 'min' %}selected{% endif %}>MINIMUM</option>
                <option value="count" {% if query_state.aggregation_function == 'count' %}selected{% endif %}>COUNT</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Column (Optional)</label>
              <select name="aggregation_column" class="form-select">
                <option value="">Select Column</option>
                {% for col in columns %}
                  <option value="{{ col }}" {% if query_state.aggregation_column == col %}selected{% endif %}>{{ col }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="button-group">
              <button type="submit" class="btn btn-success">Apply</button>
              {% if query_state.aggregation_column or query_state.aggregation_group_by %}
              <button type="submit" formaction="/?action=clear_aggregation" class="btn btn-secondary">Clear</button>
              {% endif %}
            </div>
          </form>
        </div>

        <div id="tab-join" class="tab-content">
          <form method="post" action="/?action=join_dataset">
            <div class="form-group">
              <label class="form-label">Join With</label>
              <select name="join_dataset" id="joinDatasetSelect" class="form-select" onchange="loadJoinColumns()">
                <option value="">Select Dataset</option>
                {% for ds in available_datasets %}
                  {% if ds != current_dataset %}
                    <option value="{{ ds }}" {% if query_state.join_dataset == ds %}selected{% endif %}>{{ ds }}</option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Left Column</label>
                <select name="join_left_col" class="form-select">
                  {% for col in schema.keys() %}
                    <option value="{{ col }}" {% if query_state.join_left_col == col %}selected{% endif %}>{{ col }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Right Column</label>
                <select name="join_right_col" id="joinRightCol" class="form-select">
                  <option value="">Select Column</option>
                </select>
              </div>
            </div>
            <div class="button-group">
              <button type="submit" class="btn btn-success">Apply Join</button>
              {% if query_state.join_dataset %}
              <button type="submit" formaction="/?action=clear_join" class="btn btn-secondary">Clear</button>
              {% endif %}
            </div>
          </form>
        </div>

        <div id="tab-limit" class="tab-content">
          <form method="post" action="/?action=update_limit">
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" name="use_limit" id="use_limit" 
                       {% if query_state.use_limit %}checked{% endif %} onchange="toggleLimitInput()">
                Enable Row Limit
              </label>
            </div>
            
            <div id="limitInput" {% if not query_state.use_limit %}style="display:none"{% endif %}>
              <div class="form-group">
                <label class="form-label">Number of Rows</label>
                <input type="number" name="limit" class="form-input" 
                       value="{{ query_state.limit }}" min="1" placeholder="50">
              </div>
            </div>
            
            <div class="button-group">
              <button type="submit" class="btn btn-primary">Apply</button>
            </div>
          </form>
        </div>

        <div class="button-group" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
          <form method="post" action="/?action=execute_query" style="display: inline;">
            <button type="submit" class="btn btn-primary">Run Query</button>
          </form>
          <form method="post" action="/?action=clear_all" style="display: inline;">
            <button type="submit" class="btn btn-danger">Clear All</button>
          </form>
        </div>

        {% if error %}
          <div class="alert alert-error">{{ error }}</div>
        {% endif %}

        {% if success %}
          <div class="alert alert-success">{{ success }}</div>
        {% endif %}

        {% if aggregation_info %}
          <div class="alert alert-info">{{ aggregation_info }}</div>
        {% endif %}

        {% if results %}
          <div class="results-table-wrapper">
            <table class="results-table">
              <thead>
                <tr>
                  {% for col in result_columns %}
                    <th>{{ col }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for row in results %}
                  <tr>
                    {% for col in result_columns %}
                      <td>
                        {% if row[col] is number %}
                          {{ "%.2f"|format(row[col]) if row[col] is float else row[col] }}
                        {% else %}
                          {{ row[col] }}
                        {% endif %}
                      </td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div style="margin-top: 10px; font-size: 13px; color: #666;">
            Showing {{ results|length }} of {{ total_rows }} row(s) with {{ result_columns|length }} column(s)
          </div>
        {% endif %}
      </div>

      <div class="card">
        <h2 class="card-title">Dataset Info</h2>
        
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Rows</div>
            <div class="info-value">{{ row_count }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Columns</div>
            <div class="info-value">{{ schema|length }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Types</div>
            <div class="info-value">{{ unique_types }}</div>
          </div>
        </div>

        <h3 style="font-size: 16px; margin-bottom: 10px;">Schema</h3>
        <div style="max-height: 400px; overflow-y: auto;">
          <table class="schema-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Column</th>
                <th>Type</th>
              </tr>
            </thead>
            <tbody>
              {% for col_name, col_type in schema.items() %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td>{{ col_name }}</td>
                  <td>{{ col_type }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {% if current_dataset and current_dataset in chunk_stats %}
        <h3 style="font-size: 16px; margin: 20px 0 10px;">Loading Stats</h3>
        <div style="font-size: 13px; color: #666; line-height: 1.8;">
          <div><strong>Strategy:</strong> {{ chunk_stats[current_dataset].get('strategy', 'N/A').upper() }}</div>
          <div><strong>Load Time:</strong> {{ "%.2f"|format(chunk_stats[current_dataset].get('load_time', 0)) }}s</div>
          <div><strong>File Size:</strong> {{ "%.2f"|format(chunk_stats[current_dataset].get('file_size_mb', 0)) }}MB</div>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>

  <script>
    function switchTab(tabName, clickedButton) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      document.getElementById('tab-' + tabName).classList.add('active');
      clickedButton.classList.add('active');
    }

    function toggleColumnSelection() {
      const showAll = document.getElementById('show_all_columns').checked;
      document.getElementById('columnSelection').style.display = showAll ? 'none' : 'block';
    }

    function toggleLimitInput() {
      const useLimit = document.getElementById('use_limit').checked;
      document.getElementById('limitInput').style.display = useLimit ? 'block' : 'none';
    }

    function loadJoinColumns() {
      const dataset = document.getElementById('joinDatasetSelect').value;
      const rightColSelect = document.getElementById('joinRightCol');
      
      rightColSelect.innerHTML = '<option value="">Loading...</option>';
      
      if (!dataset) {
        rightColSelect.innerHTML = '<option value="">Select Column</option>';
        return;
      }
      
      fetch('/api/dataset_columns/' + dataset)
        .then(response => response.json())
        .then(data => {
          rightColSelect.innerHTML = '<option value="">Select Column</option>';
          data.columns.forEach(col => {
            const option = document.createElement('option');
            option.value = col;
            option.textContent = col;
            
            // Re-select previously selected join column
            {% if query_state.join_right_col %}
            if (col === '{{ query_state.join_right_col }}') {
              option.selected = true;
            }
            {% endif %}
            
            rightColSelect.appendChild(option);
          });
        });
    }

    function loadSelectedDataset() {
      const select = document.getElementById('datasetSelect');
      const dataset = select.value;
      
      if (!dataset) {
        alert('Please select a dataset');
        return;
      }

      // Show loading message
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Loading...';

      fetch('/api/load_dataset', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({dataset: dataset})
      })
      .then(response => response.json())
      .then(data => {
        // Reload page to display the newly loaded dataset
        window.location.href = '/?dataset=' + dataset; 
      })
      .catch(error => {
        btn.disabled = false;
        btn.textContent = 'Load';
        alert('Error loading dataset: ' + error);
      });
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Initialize state for column selection and limit inputs
      toggleColumnSelection();
      toggleLimitInput();

      {% if query_state.join_dataset %}
      // Load join columns if a join dataset is already selected
      loadJoinColumns();
      {% endif %}
    });
  </script>
</body>
</html>